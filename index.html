<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TSS Lighting Designer ‚Äî with Floorplan Builder</title>
<style>
  :root{--bg:#0f1115;--panel:#151922;--ink:#e7eaf0;--muted:#9aa3b2;--accent:#5ea0ff;--chip-blue:#2d6bff;--chip-green:#1ea97c;--chip-yellow:#ffd23c;--chip-red:#e34f4f}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid #222838;gap:10px;flex-wrap:wrap}
  h1{font-size:16px;margin:0}
  .btn{background:#1e2430;color:#e7eaf0;border:1px solid #2a3142;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn:hover{border-color:#3a455c}
  .danger{background:#2a1313;border-color:#5a2323}
  .wrap{display:grid;grid-template-columns:320px 1fr;height:calc(100% - 106px)}
  body.builder-active .wrap{grid-template-columns:1fr}
  aside{background:var(--panel);border-right:1px solid #222838;overflow:auto}
  body.builder-active aside{display:none}
  .slot{padding:12px;border-bottom:1px solid #202534}
  .slot h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  input#search{width:100%;padding:8px;border-radius:8px;border:1px solid #2a3142;background:#0f1420;color:#e7eaf0}
  .palette{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .pill{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:#1b2030;border:1px solid #2a3142;cursor:grab}
  .ico{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;color:#000;font-weight:700;font-size:11px}
  .ico.blue{background:var(--chip-blue);color:#fff}
  .ico.green{background:var(--chip-green);color:#fff}
  .ico.yellow{background:var(--chip-yellow)}
  .ico.red{background:var(--chip-red);color:#fff}
  .pill span{font-size:12px}
  .stage-wrap{position:relative;overflow:auto}
  .dropzone{position:relative;margin:12px;border:2px dashed #2a3142;border-radius:12px;min-height:520px;min-width:480px;display:grid;place-items:center;color:var(--muted);resize:both;overflow:auto;background:#0f1115}
  .dropzone.drag{border-color:var(--accent);box-shadow:0 0 0 3px rgba(94,160,255,.2) inset}
  body.builder-active .dropzone{background:#ffffff;color:#666}
  #floor{max-width:100%;width:100%;height:auto;display:block;border-radius:10px}
  .hint{position:absolute;text-align:center;font-size:14px;pointer-events:none}
  .hint b{color:#dfe6f5}
  .tag{position:absolute;left:40px;top:40px;transform-origin:center;padding:6px 10px 6px 8px;border-radius:10px;background:#223;border:1px solid #2a3142;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.25);display:flex;align-items:center;gap:8px;cursor:grab;touch-action:none}
  .tag.drag{cursor:grabbing;opacity:.95}
  .tag .label{font-size:13px;font-weight:700;letter-spacing:.2px}
  .zoombar{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .zoombar input[type=range]{width:160px}
  .sep{width:1px;height:30px;background:#2a3142;margin:0 4px}
  /* --- Builder --- */
  .builderbar{display:flex;gap:6px;align-items:center;padding:8px 12px;background:#0f1420;border-bottom:1px solid #222838;flex-wrap:wrap}
  .builderbar .btn{background:#1b2030}
  #overlay{position:absolute;inset:0;overflow:visible;pointer-events:none}
  .grid-on{background-size:20px 20px, 100px 100px; background-image:
    linear-gradient(to right, rgba(0,0,0,.06) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(0,0,0,.06) 1px, transparent 1px)}
  body:not(.builder-active) .builderbar{display:none}
  .shape{cursor:move}
  .handle{fill:#5ea0ff;stroke:#0b1220;stroke-width:1;cursor:grab}
  .handle:hover{fill:#7bb4ff}
  .label-txt{font: 12px system-ui; fill:#111; paint-order:stroke; stroke:#fff; stroke-width:2}
</style>
</head>
<body>
<!-- Inline icon symbols for equipment pills -->
<svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="ico-camera" viewBox="0 0 24 24"><path fill="currentColor" d="M9 7l1.5-2h3L15 7h3a3 3 0 013 3v7a3 3 0 01-3 3H6a3 3 0 01-3-3v-7a3 3 0 013-3h3zm3 3a5 5 0 100 10 5 5 0 000-10z"/></symbol>
  <symbol id="ico-fresnel" viewBox="0 0 24 24"><path fill="currentColor" d="M3 7h12l6 5-6 5H3zM8 7v10"/></symbol>
  <symbol id="ico-skypanel" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" fill="currentColor"/><path d="M6 9h12M6 12h12M6 15h6" stroke="#0f1115" stroke-width="1.5"/></symbol>
  <symbol id="ico-panel" viewBox="0 0 24 24"><rect x="4" y="5" width="16" height="14" rx="2" fill="currentColor"/></symbol>
  <symbol id="ico-flag" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3v18"/><path d="M7 4h12l-4 5h-8z" fill="currentColor"/></symbol>
  <symbol id="ico-frame" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="1" fill="currentColor"/></symbol>
  <symbol id="ico-cstand" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3v10m-5 8h10M9 21l3-8 3 8" stroke="currentColor" stroke-width="1.5"/></symbol>
  <symbol id="ico-combo" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3v10m-6 8h12M8 21l4-7 4 7" stroke="currentColor" stroke-width="1.5"/></symbol>
  <symbol id="ico-sandbag" viewBox="0 0 24 24"><path d="M6 18h12l-2-7H8z" fill="currentColor"/></symbol>
  <symbol id="ico-bulb" viewBox="0 0 24 24"><path d="M12 3a7 7 0 00-4 13v3h8v-3a7 7 0 00-4-13z" fill="currentColor"/></symbol>
  <symbol id="ico-cable" viewBox="0 0 24 24"><path d="M4 10c4 0 4 6 8 6s4-6 8-6" stroke="currentColor" stroke-width="1.5" fill="none"/></symbol>
  <symbol id="ico-point-light" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M3 12h5M16 12h5M12 3v5M12 16v5" stroke="currentColor" stroke-width="1.5"/></symbol>
</svg>

<header>
  <h1>üé• TSS Lighting Designer</h1>
  <div class="zoombar">
    <button id="toggleBuilder" class="btn">Enable Builder</button>
    <span class="sep"></span>
    <button id="imgBtn" class="btn">üìÑ Set Floor Plan</button>
    <button id="clearImgBtn" class="btn danger">Clear Image</button>
    <span class="sep"></span>
    <button id="fitBtn" class="btn">Fit Width</button>
    <button id="zoomOut" class="btn">‚àí</button>
    <input type="range" id="zoomRange" min="50" max="200" value="100"/>
    <button id="zoomIn" class="btn">+</button>
    <span class="sep"></span>
    <button id="saveAsFloorBtn" class="btn">üíæ Save As Floor Plan</button>
    <button id="exportBtn" class="btn">Export JSON</button>
    <button id="importBtn" class="btn">Import JSON</button>
  </div>
</header>

<div class="builderbar" id="builderBar">
  <button id="gridBtn" class="btn">Grid: Off</button>
  <button id="toolRect" class="btn">‚ñ≠ Rect</button>
  <button id="toolWall" class="btn">Ôºè Wall</button>
  <button id="toolText" class="btn">T Text</button>
  <button id="setScale" class="btn">Set Scale</button>
  <button id="exportPNG" class="btn">Export PNG</button>
  <button id="exportSVG" class="btn">Export SVG</button>
  <button id="newBlank" class="btn danger">New Blank Plan</button>
</div>

<div class="wrap">
  <aside>
    <div class="slot">
      <h3>Library</h3>
      <input id="search" placeholder="Search equipment‚Ä¶"/>
      <p style="color:#9aa3b2;font-size:12px;margin:.5rem 0 0">Tip: Paste a floor plan with <b>Ctrl/Cmd + V</b>.</p>
    </div>
    <div class="slot"><h3>Camera</h3><div class="palette" id="pal-camera"></div></div>
    <div class="slot"><h3>Talent / Set</h3><div class="palette" id="pal-set"></div></div>
    <div class="slot"><h3>Lights</h3><div class="palette" id="pal-lights"></div></div>
    <div class="slot"><h3>Grip / Rigging / Support</h3><div class="palette" id="pal-grip"></div></div>
    <!-- NEW: Floorplan palette -->
    <div class="slot"><h3>Floorplan Elements</h3><div class="palette" id="pal-floorplan"></div></div>
  </aside>
  <div class="stage-wrap">
    <div class="dropzone" id="drop">
      <img id="floor" src="" alt=""/>
      <!-- overlay where we draw shapes & place symbols -->
      <svg id="overlay" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="hint" id="hint">Drop a floor plan image here, <b>Paste</b> (Ctrl/Cmd+V), or click <b>Set Floor Plan</b>.<br/>Then drag items from the left palette or draw shapes in Builder mode.</div>
    </div>
  </div>
</div>

<dialog id="picker">
  <div class="modal">
    <h2>Set Floor Plan</h2>
    <div class="row">
      <input type="file" id="fileInput" accept="image/*" class="btn"/>
      <button id="useFile" class="btn">Use File</button>
    </div>
    <div class="row">
      <input type="text" id="urlInput" placeholder="Paste image URL (https://...)"/>
      <button id="useURL" class="btn">Use URL</button>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="closePicker" class="btn">Close</button>
    </div>
  </div>
</dialog>

<!-- Equipment catalog (trimmed example; keep yours here or load from JSON) -->
<script id="catalog" type="application/json">{
  "version":1,
  "items":[
    {"id":"arri-alexa-mini-kit","name":"ARRI Alexa Mini + Accessories (Matte Box)","category":"camera","icon":"camera"},
    {"id":"zeiss-ultra-prime-kit","name":"Zeiss Ultra Prime Lens Kit","category":"camera","icon":"frame"},
    {"id":"arri-wcu4","name":"ARRI WCU-4 Remote FIZ","category":"camera","icon":"panel"},
    {"id":"teradek-monitor-kit","name":"Teradek Remote Monitor Kit","category":"camera","icon":"panel"},
    {"id":"flanders-monitor","name":"Flanders Scientific Monitor","category":"misc","icon":"panel"},

    {"id":"nanlite-forza-500b","name":"Nanlite Forza 500B","category":"lights","icon":"panel"},
    {"id":"arri-skypanel-s60c","name":"ARRI Skypanel (S60)","category":"lights","icon":"skypanel"},
    {"id":"inky-200","name":"Inky (Mole 200W)","category":"lights","icon":"fresnel"},
    {"id":"tweenie-650","name":"Tweenie (650W)","category":"lights","icon":"fresnel"},
    {"id":"hmi-light","name":"HMI (Generic)","category":"lights","icon":"point-light"},

    {"id":"c-stand","name":"C-Stand + Gobo Arm","category":"grip","icon":"cstand"},
    {"id":"combo-stand","name":"Combo Stand","category":"grip","icon":"combo"},
    {"id":"sandbag-25","name":"Sandbag 25 lb","category":"grip","icon":"sandbag"},

    {"id":"subject","name":"Subject / Actor","category":"set","icon":"camera"},
    {"id":"table","name":"Table","category":"set","icon":"frame"},
    {"id":"chair","name":"Chair","category":"set","icon":"frame"},

    {"id":"stinger-25","name":"Stinger 25‚Ä≤ 12/3","category":"power","icon":"cable"},
    {"id":"distro-box","name":"Distro Box / Lunchbox","category":"power","icon":"cable"},

    {"id":"colorchecker","name":"ColorChecker Video","category":"misc","icon":"panel"},
    {"id":"slate","name":"Slate / Clapboard","category":"misc","icon":"panel"}
  ]
}</script>

<script>
(function(){
  var LS={layout:'tssld-layout-v4', image:'tssld-image-v4', zoom:'tssld-zoom-v4', scale:'tssld-scale-v4'};
  var ICON_MAP={camera:'ico-camera',fresnel:'ico-fresnel',skypanel:'ico-skypanel',panel:'ico-panel',flag:'ico-flag',frame:'ico-frame',cstand:'ico-cstand',combo:'ico-combo',sandbag:'ico-sandbag',bulb:'ico-bulb',cable:'ico-cable','point-light':'ico-point-light'};

  var body=document.body;
  var drop=document.getElementById('drop'), floor=document.getElementById('floor'), hint=document.getElementById('hint');
  var overlay=document.getElementById('overlay');
  var picker=document.getElementById('picker'), imgBtn=document.getElementById('imgBtn'), fileInput=document.getElementById('fileInput'), urlInput=document.getElementById('urlInput');
  var exportBtn=document.getElementById('exportBtn'), importBtn=document.getElementById('importBtn');
  var zoomIn=document.getElementById('zoomIn'), zoomOut=document.getElementById('zoomOut'), zoomRange=document.getElementById('zoomRange'), fitBtn=document.getElementById('fitBtn');
  var clearImgBtn=document.getElementById('clearImgBtn');
  var toggleBuilder=document.getElementById('toggleBuilder');
  var gridBtn=document.getElementById('gridBtn');
  var toolRect=document.getElementById('toolRect');
  var toolWall=document.getElementById('toolWall');
  var toolText=document.getElementById('toolText');
  var setScaleBtn=document.getElementById('setScale');
  var exportPNGBtn=document.getElementById('exportPNG');
  var exportSVGBtn=document.getElementById('exportSVG');
  var newBlankBtn=document.getElementById('newBlank');
  var saveAsFloorBtn=document.getElementById('saveAsFloorBtn');

  var CATALOG = JSON.parse(document.getElementById('catalog').textContent);

  /* ---------- Zoom ---------- */
  var baseWidth = 960; var zoom = parseFloat(localStorage.getItem(LS.zoom) || '1');
  function pxToPct(x,y){ var w = drop.clientWidth||1, h = drop.clientHeight||1; return {x: +(x/w*100).toFixed(4), y: +(y/h*100).toFixed(4)}; }
  function pctToPx(xPct,yPct){ var w=drop.clientWidth||1, h=drop.clientHeight||1; return {x:xPct/100*w, y:yPct/100*h}; }
  function repositionFromPercent(){ Array.prototype.forEach.call(drop.querySelectorAll('.tag'), function(tag){ if(tag.dataset.leftPct && tag.dataset.topPct){ tag.style.left = tag.dataset.leftPct+'%'; tag.style.top = tag.dataset.topPct+'%'; }}); }
  function applyZoom(){ var px=Math.max(480, Math.round(baseWidth*zoom)); drop.style.width=px+'px'; repositionFromPercent(); if(zoomRange) zoomRange.value=Math.round(zoom*100); localStorage.setItem(LS.zoom, String(zoom)); }
  function fitWidth(){ var wrap=drop.parentElement.clientWidth-24; if(baseWidth>0){ zoom=Math.max(0.3, Math.min(3, wrap/baseWidth)); applyZoom(); }}
  zoomIn.addEventListener('click', function(){ zoom=Math.min(3, zoom+0.1); applyZoom(); });
  zoomOut.addEventListener('click', function(){ zoom=Math.max(0.3, zoom-0.1); applyZoom(); });
  zoomRange.addEventListener('input', function(e){ zoom=Math.max(0.3, Math.min(3, e.target.value/100)); applyZoom(); });
  fitBtn.addEventListener('click', fitWidth);
  window.addEventListener('resize', function(){ repositionFromPercent(); resizeOverlay(); });

  /* ---------- Library (equipment) ---------- */
  function pickColor(category){ if(category==='camera')return'blue'; if(category==='lights')return'yellow'; if(category==='grip'||category==='rigging')return'red'; if(category==='set'||category==='practicals'||category==='power'||category==='misc')return'green'; return'green'; }
  function pal(id){ return document.getElementById('pal-'+id); }
  function paletteMounts(){ return {camera:pal('camera'), set:pal('set'), lights:pal('lights'), grip:pal('grip')}; }

  function makePillFromItem(item){
    var pill=document.createElement('div'); pill.className='pill'; pill.draggable=true;
    var ico=document.createElementNS('http://www.w3.org/2000/svg','svg'); ico.setAttribute('class','ico '+pickColor(item.category));
    var use=document.createElementNS('http://www.w3.org/2000/svg','use'); use.setAttributeNS('http://www.w3.org/1999/xlink','href','#'+(ICON_MAP[item.icon]||ICON_MAP.camera)); ico.appendChild(use);
    var label=document.createElement('span'); label.textContent=item.name;
    pill.appendChild(ico); pill.appendChild(label);
    pill.addEventListener('dragstart', function(ev){ ev.dataTransfer.setData('application/json', JSON.stringify({type:item.id,label:item.name,color:pickColor(item.category),icon:(ICON_MAP[item.icon]||ICON_MAP.camera)})); });
    pill.addEventListener('click', function(){ createTag({type:item.id,label:item.name,color:pickColor(item.category),icon:(ICON_MAP[item.icon]||ICON_MAP.camera)}, 80, 80); });
    return pill;
  }
  function renderPalettes(filter){
    var mounts=paletteMounts(); Object.keys(mounts).forEach(function(k){ mounts[k].innerHTML=''; });
    var term=(filter||'').toLowerCase();
    var byCat={};
    CATALOG.items.forEach(function(it){
      if(term && !(it.name.toLowerCase().indexOf(term)>-1 || it.id.indexOf(term)>-1)) return;
      if(!byCat[it.category]) byCat[it.category]=[];
      byCat[it.category].push(it);
    });
    Object.keys(byCat).forEach(function(cat){
      var mount = mounts[cat] || mounts.set;
      byCat[cat].forEach(function(item){ mount.appendChild(makePillFromItem(item)); });
    });
  }
  renderPalettes('');
  document.getElementById('search').addEventListener('input', function(e){ renderPalettes(e.target.value); });

  /* ---------- Tags (equipment) ---------- */
  function createTag(def, x, y, text){
    var tag=document.createElement('div'); tag.className='tag';
    tag.dataset.type=def.type; tag.dataset.color=def.color;
    var svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('class','ico '+def.color);
    var use=document.createElementNS('http://www.w3.org/2000/svg','use'); use.setAttributeNS('http://www.w3.org/1999/xlink','href','#'+def.icon); svg.appendChild(use);
    var label=document.createElement('div'); label.className='label'; label.textContent=text||def.label;
    tag.appendChild(svg); tag.appendChild(label);
    drop.appendChild(tag);
    var pct = pxToPct(x, y);
    tag.style.left = pct.x + '%'; tag.style.top = pct.y + '%';
    tag.dataset.leftPct = pct.x; tag.dataset.topPct = pct.y;
    makeDraggable(tag);
    save();
    return tag;
  }
  function makeDraggable(el){
    var sx=0, sy=0, lx=0, ty=0, drag=false;
    var down=function(ev){
      var e=ev.touches?ev.touches[0]:ev; drag=true; el.classList.add('drag');
      var bbox=el.getBoundingClientRect(); var pr=drop.getBoundingClientRect();
      sx=e.clientX; sy=e.clientY; lx=bbox.left-pr.left; ty=bbox.top-pr.top;
      document.addEventListener('mousemove',move); document.addEventListener('mouseup',up);
      document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',up); ev.preventDefault();
    };
    var move=function(ev){
      if(!drag) return; var e=ev.touches?ev.touches[0]:ev; var nx=lx+e.clientX-sx; var ny=ty+e.clientY-sy; var pct = pxToPct(nx, ny);
      el.style.left=pct.x+'%'; el.style.top=pct.y+'%'; el.dataset.leftPct=pct.x; el.dataset.topPct=pct.y; ev.preventDefault();
    };
    var up=function(){ if(!drag) return; drag=false; el.classList.remove('drag'); document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); document.removeEventListener('touchmove',move); document.removeEventListener('touchend',up); save(); };
    el.addEventListener('mousedown',down); el.addEventListener('touchstart',down,{passive:false});
    el.addEventListener('dblclick',function(){ var t=prompt('Rename label:', el.querySelector('.label').textContent.trim()); if(t!==null){ el.querySelector('.label').textContent=t; save(); }});
    el.addEventListener('contextmenu', function(e){ e.preventDefault(); var c=prompt('dup (duplicate), rot (rotate 90¬∞), del (delete)'); if(!c) return; if(c==='dup'){ var pos=pctToPx(parseFloat(el.dataset.leftPct||'3'), parseFloat(el.dataset.topPct||'3')); createTag({type:el.dataset.type,label:el.querySelector('.label').textContent,color:el.dataset.color,icon:el.querySelector('use').getAttribute('href').slice(1)}, pos.x+20, pos.y+20); } else if(c==='rot'){ var m=(el.style.transform.match(/rotate\(([-\d]+)deg\)/)||[null,'0']); var n=(parseInt(m[1],10)+90)%360; el.style.transform='rotate('+n+'deg)'; save(); } else if(c==='del'){ el.remove(); save(); } });
  }

  /* ---------- Floorplan symbols loader & palette ---------- */
  var palFloor = document.getElementById('pal-floorplan');
  (function loadFloorplanSymbols(){
    if(!palFloor) return;
    var url='assets/floorplan/symbols.svg';
    fetch(url, {cache:'no-store'})
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(function(svgText){
        var holder=document.createElement('div'); holder.style.display='none'; holder.innerHTML=svgText; document.body.prepend(holder);
        var ids = []; var re = /<symbol\s+id="([^"]+)"/g; var m; while((m=re.exec(svgText))!==null){ ids.push(m[1]); }
        ids.slice(0,200).forEach(function(id){
          var pill=document.createElement('div'); pill.className='pill'; pill.draggable=true;
          var ico=document.createElementNS('http://www.w3.org/2000/svg','svg'); ico.setAttribute('class','ico yellow');
          var u=document.createElementNS('http://www.w3.org/2000/svg','use'); u.setAttributeNS('http://www.w3.org/1999/xlink','href','#'+id); ico.appendChild(u);
          var label=document.createElement('span'); label.textContent=id.replace(/^fp[-_]?/,'');
          pill.appendChild(ico); pill.appendChild(label);
          pill.addEventListener('dragstart', function(ev){ ev.dataTransfer.setData('text/x-fp-symbol', id); });
          pill.addEventListener('click', function(){ placeSymbol(id, 100, 100, 0, 1); save(); });
          palFloor.appendChild(pill);
        });
        console.log('‚úÖ Loaded floorplan symbols');
      })
      .catch(function(err){ console.error('Could not load symbols.svg:', err); });
  })();

  /* ---------- Drop handling (symbols, equipment, images) ---------- */
  drop.addEventListener('dragover', function(e){ e.preventDefault(); });
  drop.addEventListener('drop', function(e){
    e.preventDefault();
    // A) floorplan symbol?
    var symId = e.dataTransfer.getData('text/x-fp-symbol');
    if(symId){
      var rect=drop.getBoundingClientRect(); var x=e.clientX-rect.left; var y=e.clientY-rect.top;
      placeSymbol(symId, x, y, 0, 1); save(); return;
    }
    // B) equipment tag?
    var data=e.dataTransfer.getData('application/json');
    if(data){
      var def=JSON.parse(data); var r=drop.getBoundingClientRect();
      createTag(def, e.clientX-r.left-40, e.clientY-r.top-20); return;
    }
    // C) image?
    var f=e.dataTransfer.files && e.dataTransfer.files[0];
    if(f && f.type.indexOf('image/')===0){ var fr=new FileReader(); fr.onload=function(ev){ setImage(ev.target.result); }; fr.readAsDataURL(f); }
  });

  /* ---------- Floorplan symbol placement & persistence ---------- */
  function placeSymbol(symbolId, x, y, rotation, scale){
    rotation = rotation||0; scale = scale||1;
    var g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('data-sym',symbolId);
    g.setAttribute('data-x',x); g.setAttribute('data-y',y);
    g.setAttribute('data-rot',rotation); g.setAttribute('data-sc',scale);
    g.setAttribute('transform','translate('+x+','+y+') rotate('+rotation+') scale('+scale+')');

    var u=document.createElementNS('http://www.w3.org/2000/svg','use');
    u.setAttributeNS('http://www.w3.org/1999/xlink','href','#'+symbolId);
    g.appendChild(u);

    g.style.pointerEvents='auto';
    var dragging=false, sx=0, sy=0, ox=x, oy=y;
    g.addEventListener('mousedown', function(ev){
      if(!body.classList.contains('builder-active')) return;
      dragging=true; sx=ev.clientX; sy=ev.clientY; ox=x; oy=y; ev.preventDefault();
      function mv(e){ if(!dragging) return; x=ox+(e.clientX-sx); y=oy+(e.clientY-sy);
        g.setAttribute('data-x',x); g.setAttribute('data-y',y);
        g.setAttribute('transform','translate('+x+','+y+') rotate('+rotation+') scale('+scale+')'); }
      function up(){ if(!dragging) return; dragging=false; window.removeEventListener('mousemove',mv); window.removeEventListener('mouseup',up); save(); }
      window.addEventListener('mousemove',mv); window.addEventListener('mouseup',up);
    });
    g.addEventListener('contextmenu', function(e){
      e.preventDefault(); if(!body.classList.contains('builder-active')) return;
      var cmd=prompt('dup (duplicate), del (delete)'); if(cmd==='dup'){ placeSymbol(symbolId, x+20, y+20, rotation, scale); save(); } else if(cmd==='del'){ g.remove(); save(); }
    });

    overlay.appendChild(g);
  }
  function serializeSymbols(){
    var arr=[]; overlay.querySelectorAll('g[data-sym]').forEach(function(g){
      arr.push({ id:g.getAttribute('data-sym'),
        x:parseFloat(g.getAttribute('data-x')||'0'),
        y:parseFloat(g.getAttribute('data-y')||'0'),
        rot:parseFloat(g.getAttribute('data-rot')||'0'),
        sc:parseFloat(g.getAttribute('data-sc')||'1') });
    }); return arr;
  }
  function hydrateSymbols(list){
    overlay.querySelectorAll('g[data-sym]').forEach(function(g){ g.remove(); });
    (list||[]).forEach(function(s){ placeSymbol(s.id, s.x, s.y, s.rot||0, s.sc||1); });
  }

  /* ---------- Builder shapes ---------- */
  var buildOn=true, tool='rect', scalePxPerFoot=parseFloat(localStorage.getItem(LS.scale)||'0');
  toggleBuilder.addEventListener('click', function(){ buildOn=!buildOn; toggleBuilder.textContent= buildOn? 'Disable Builder' : 'Enable Builder'; overlay.style.pointerEvents = buildOn? 'auto':'none'; body.classList.toggle('builder-active', buildOn); });
  gridBtn.addEventListener('click', function(){ drop.classList.toggle('grid-on'); gridBtn.textContent = drop.classList.contains('grid-on')? 'Grid: On' : 'Grid: Off'; });
  toolRect.addEventListener('click', function(){ tool='rect'; });
  toolWall.addEventListener('click', function(){ tool='wall'; });
  toolText.addEventListener('click', function(){ tool='text'; });
  setScaleBtn.addEventListener('click', function(){ var v=prompt('Enter scale: pixels per foot (e.g., 20)', scalePxPerFoot||''); if(v!==null){ scalePxPerFoot=parseFloat(v)||0; localStorage.setItem(LS.scale, String(scalePxPerFoot)); }});

  function snap(v){ return drop.classList.contains('grid-on')? Math.round(v/10)*10 : v; }
  var tempShape=null, start={x:0,y:0};
  overlay.addEventListener('mousedown', function(e){
    if(!buildOn) return;
    var pt=clientToLocal(e); start=pt;
    if(tool==='rect'){ tempShape = createRect(pt.x, pt.y, 1, 1); }
    else if(tool==='wall'){ tempShape = createWall(pt.x, pt.y, pt.x+1, pt.y+1); }
    else if(tool==='text'){ var t=prompt('Text label:','New Room'); if(t){ createText(pt.x, pt.y, t); save(); } }
  });
  overlay.addEventListener('mousemove', function(e){
    if(!buildOn||!tempShape) return; var pt=clientToLocal(e);
    if(tempShape.dataset.kind==='rect'){ var x=Math.min(start.x, pt.x), y=Math.min(start.y, pt.y), w=Math.abs(pt.x-start.x), h=Math.abs(pt.y-start.y); updateRect(tempShape, x,y,w,h); }
    else if(tempShape.dataset.kind==='wall'){ updateWall(tempShape, start.x,start.y, pt.x,pt.y); }
  });
  window.addEventListener('mouseup', function(){ if(tempShape){ tempShape=null; save(); } });

  function clientToLocal(e){ var r=overlay.getBoundingClientRect(); return {x:snap(e.clientX-r.left), y:snap(e.clientY-r.top)}; }
  function svgEl(name, attrs){ var el=document.createElementNS('http://www.w3.org/2000/svg', name); for(var k in attrs){ el.setAttribute(k, attrs[k]); } return el; }
  function addDrag(g){ g.addEventListener('mousedown', function(e){ if(!buildOn) return; if(e.target.classList.contains('handle')) return; var p0=clientToLocal(e); var bbox=g.getBBox(); var dx=bbox.x - p0.x, dy=bbox.y - p0.y; function mv(ev){ var p=clientToLocal(ev); var nx=p.x+dx, ny=p.y+dy; if(g.dataset.kind==='rect'){ updateRect(g, nx, ny, bbox.width, bbox.height); } else if(g.dataset.kind==='text'){ var t=g.querySelector('text'); t.setAttribute('x', nx); t.setAttribute('y', ny); } } function up(){ window.removeEventListener('mousemove',mv); window.removeEventListener('mouseup',up); save(); } window.addEventListener('mousemove',mv); window.addEventListener('mouseup',up); }); g.addEventListener('dblclick', function(){ if(g.dataset.kind==='text'){ var t=g.querySelector('text'); var nv=prompt('Edit label:', t.textContent); if(nv!==null){ t.textContent=nv; save(); } } }); g.addEventListener('contextmenu',function(e){ e.preventDefault(); var c=prompt('dup (duplicate), del (delete)'); if(c==='dup'){ duplicateShape(g); } else if(c==='del'){ g.remove(); save(); } }); }
  function createRect(x,y,w,h){ var g=svgEl('g',{'class':'shape','data-kind':'rect'}); var r=svgEl('rect',{x:x,y:y,width:w,height:h,fill:'rgba(100,150,255,0.15)',stroke:'#5ea0ff','stroke-width':2}); g.appendChild(r); addDrag(g); overlay.appendChild(g); return g; }
  function updateRect(g,x,y,w,h){ var r=g.querySelector('rect'); r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',w); r.setAttribute('height',h); }
  function createWall(x1,y1,x2,y2){ var g=svgEl('g',{'class':'shape','data-kind':'wall'}); var l=svgEl('line',{x1:x1,y1:y1,x2:x2,y2:y2,stroke:'#ffd23c','stroke-width':4}); g.appendChild(l); addEndpointHandles(g); overlay.appendChild(g); return g; }
  function updateWall(g,x1,y1,x2,y2){ var l=g.querySelector('line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); updateHandles(g); }
  function createText(x,y,txt){ var g=svgEl('g',{'class':'shape','data-kind':'text'}); var t=svgEl('text',{x:x,y:y,'class':'label-txt'}); t.textContent=txt; g.appendChild(t); addDrag(g); overlay.appendChild(g); return g; }
  function addEndpointHandles(g){ var l=g.querySelector('line'); var h1=svgEl('circle',{'class':'handle',r:6}); var h2=svgEl('circle',{'class':'handle',r:6}); g.appendChild(h1); g.appendChild(h2); function dragHandle(h,which){ h.addEventListener('mousedown',function(e){ if(!buildOn) return; e.stopPropagation(); function move(ev){ var p=clientToLocal(ev); if(which===1){ l.setAttribute('x1',p.x); l.setAttribute('y1',p.y);} else { l.setAttribute('x2',p.x); l.setAttribute('y2',p.y);} updateHandles(g); } function up(){ window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); save(); } window.addEventListener('mousemove',move); window.addEventListener('mouseup',up); }); } dragHandle(h1,1); dragHandle(h2,2); updateHandles(g); }
  function updateHandles(g){ var l=g.querySelector('line'); var x1=parseFloat(l.getAttribute('x1')), y1=parseFloat(l.getAttribute('y1')), x2=parseFloat(l.getAttribute('x2')), y2=parseFloat(l.getAttribute('y2')); var hs=g.querySelectorAll('.handle'); hs[0].setAttribute('cx',x1); hs[0].setAttribute('cy',y1); hs[1].setAttribute('cx',x2); hs[1].setAttribute('cy',y2); }
  function duplicateShape(g){ var kind=g.dataset.kind; if(kind==='rect'){ var r=g.querySelector('rect'); createRect(parseFloat(r.getAttribute('x'))+20, parseFloat(r.getAttribute('y'))+20, parseFloat(r.getAttribute('width')), parseFloat(r.getAttribute('height'))); } else if(kind==='wall'){ var l=g.querySelector('line'); createWall(parseFloat(l.getAttribute('x1'))+20, parseFloat(l.getAttribute('y1'))+20, parseFloat(l.getAttribute('x2'))+20, parseFloat(l.getAttribute('y2'))+20); } else if(kind==='text'){ var t=g.querySelector('text'); createText(parseFloat(t.getAttribute('x'))+20, parseFloat(t.getAttribute('y'))+20, t.textContent); } save(); }
  function exportShapes(){ var out=[]; overlay.querySelectorAll('.shape').forEach(function(g){ var kind=g.dataset.kind; if(kind==='rect'){ var r=g.querySelector('rect'); out.push({kind:kind,x:+r.getAttribute('x'),y:+r.getAttribute('y'),w:+r.getAttribute('width'),h:+r.getAttribute('height')}); } else if(kind==='wall'){ var l=g.querySelector('line'); out.push({kind:kind,x1:+l.getAttribute('x1'),y1:+l.getAttribute('y1'),x2:+l.getAttribute('x2'),y2:+l.getAttribute('y2')}); } else if(kind==='text'){ var t=g.querySelector('text'); out.push({kind:kind,x:+t.getAttribute('x'),y:+t.getAttribute('y'),text:t.textContent}); } }); return out; }
  function importShapes(arr){ overlay.querySelectorAll('.shape').forEach(function(g){ g.remove(); }); (arr||[]).forEach(function(s){ if(s.kind==='rect'){ createRect(s.x,s.y,s.w,s.h); } else if(s.kind==='wall'){ createWall(s.x1,s.y1,s.x2,s.y2); } else if(s.kind==='text'){ createText(s.x,s.y,s.text); } }); }

  /* ---------- Persistence ---------- */
  function serialize(){
    var items = Array.prototype.slice.call(drop.querySelectorAll('.tag')).map(function(el){
      var t = el.style.transform || ''; var rot = t.indexOf('rotate(')>-1 ? t.split('rotate(')[1].split('deg)')[0] : 0;
      return { type:el.dataset.type, color:el.dataset.color, icon:el.querySelector('use').getAttribute('href').slice(1),
        text:el.querySelector('.label').textContent.trim(), leftPct:parseFloat(el.dataset.leftPct||'0'), topPct:parseFloat(el.dataset.topPct||'0'), rot:rot };
    });
    var shapes = exportShapes();
    var symbols = serializeSymbols();
    return { items:items, shapes:shapes, symbols:symbols, scale: localStorage.getItem(LS.scale)||'' };
  }
  function hydrate(data){
    drop.querySelectorAll('.tag').forEach(function(el){ el.remove(); });
    (data.items||[]).forEach(function(it){
      var px=pctToPx(it.leftPct||3, it.topPct||3);
      var tag=createTag({type:it.type,label:it.text,color:it.color,icon:it.icon}, px.x, px.y, it.text);
      tag.dataset.leftPct=it.leftPct||3; tag.dataset.topPct=it.topPct||3; tag.style.left=(it.leftPct||3)+'%'; tag.style.top=(it.topPct||3)+'%';
      if(it.rot) tag.style.transform='rotate('+it.rot+'deg)';
    });
    hydrateSymbols(data.symbols||[]);
    importShapes(data.shapes||[]);
    if(data.scale) localStorage.setItem(LS.scale, data.scale);
  }
  function save(){ localStorage.setItem(LS.layout, JSON.stringify(serialize())); }
  function load(){ var raw=localStorage.getItem(LS.layout); if(raw){ try{ hydrate(JSON.parse(raw)); }catch(e){} } }
  load();

  /* ---------- Image handling ---------- */
  function resizeOverlay(){ overlay.setAttribute('width', drop.clientWidth); overlay.setAttribute('height', drop.clientHeight); }
  new ResizeObserver(resizeOverlay).observe(drop); resizeOverlay();

  function setImage(src){
    floor.src = src; hint.style.display = src ? 'none' : 'block'; localStorage.setItem(LS.image, src);
    var img = new Image(); img.onload = function(){ baseWidth = img.naturalWidth || floor.clientWidth || 960; applyZoom(); resizeOverlay(); }; img.src = src;
  }
  function clearImage(){ floor.src=''; hint.style.display='block'; localStorage.removeItem(LS.image); resizeOverlay(); }

  var savedImg=localStorage.getItem(LS.image); if(savedImg){ setImage(savedImg); } else { applyZoom(); }
  ;['dragenter','dragover'].forEach(function(evt){ drop.addEventListener(evt,function(e){ e.preventDefault(); drop.classList.add('drag'); }); });
  ;['dragleave','drop'].forEach(function(evt){ drop.addEventListener(evt,function(e){ e.preventDefault(); drop.classList.remove('drag'); }); });

  document.addEventListener('paste', function(e){
    var items = (e.clipboardData && e.clipboardData.items) || [];
    for (var i=0;i<items.length;i++){
      var it=items[i];
      if (it.type && it.type.indexOf('image/')===0){
        var file = it.getAsFile(); var r = new FileReader(); r.onload = function(ev){ setImage(ev.target.result); }; r.readAsDataURL(file); e.preventDefault(); break;
      }
    }
  });
  imgBtn.addEventListener('click', function(){ picker.showModal(); });
  document.getElementById('closePicker').addEventListener('click', function(){ picker.close(); });
  document.getElementById('useFile').addEventListener('click', function(){ var f=fileInput.files&&fileInput.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(ev){ setImage(ev.target.result); picker.close(); }; r.readAsDataURL(f); });
  document.getElementById('useURL').addEventListener('click', function(){ var u=urlInput.value.trim(); if(u){ setImage(u); picker.close(); }});
  clearImgBtn.addEventListener('click', clearImage);

  /* ---------- Export / Import ---------- */
  document.getElementById('exportBtn').addEventListener('click', function(){ var blob=new Blob([JSON.stringify(serialize(),null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tss-lighting-layout.json'; a.click(); });
  document.getElementById('importBtn').addEventListener('click', function(){ var i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=function(){ var f=i.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(ev){ try{ var data=JSON.parse(ev.target.result); hydrate(data); save(); }catch(e){ alert('Invalid JSON'); } }; r.readAsText(f); }; i.click(); });

  /* ---------- Builder bar misc ---------- */
  exportSVGBtn.addEventListener('click', function(){
    var svg = overlay.cloneNode(true); svg.removeAttribute('id'); var w=drop.clientWidth, h=drop.clientHeight;
    svg.setAttribute('xmlns','http://www.w3.org/2000/svg'); svg.setAttribute('width', w); svg.setAttribute('height', h);
    var ser=new XMLSerializer().serializeToString(svg); var blob=new Blob([ser],{type:'image/svg+xml'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='floorplan.svg'; a.click();
  });
  exportPNGBtn.addEventListener('click', function(){
    var w=drop.clientWidth, h=drop.clientHeight; var svg = overlay.cloneNode(true); svg.removeAttribute('id');
    svg.setAttribute('xmlns','http://www.w3.org/2000/svg'); svg.setAttribute('width', w); svg.setAttribute('height', h);
    var ser=new XMLSerializer().serializeToString(svg); var img=new Image(); var url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(ser);
    img.onload=function(){ var c=document.createElement('canvas'); c.width=w; c.height=h; var ctx=c.getContext('2d'); ctx.drawImage(img,0,0); var a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='floorplan.png'; a.click(); };
    img.src=url;
  });
  newBlankBtn.addEventListener('click', function(){ overlay.innerHTML=''; drop.querySelectorAll('.tag').forEach(function(el){ el.remove(); }); localStorage.removeItem(LS.layout); localStorage.removeItem(LS.scale); save(); });
  saveAsFloorBtn.addEventListener('click', function(){ if(!floor.src){ alert('Set a floor plan image first.'); return; } var a=document.createElement('a'); a.href=floor.src; a.download='current-floorplan.png'; a.click(); });
})();
</script>
</body>
</html>
